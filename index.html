<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Location</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        .popup { display: none; border: 1px solid #ccc; padding: 20px; background-color: #f9f9f9; }
    </style>
</head>
<body>
    <h1>Location Check</h1>
    <div id="popup" class="popup">
        <p id="message"></p>
        <p><strong>Current Address:</strong> <span id="address"></span></p>
        <p><strong>Total Distance:</strong> <span id="distance"></span> meters</p>
    </div>

    <script>
        // Default Office Location (Lat, Lon)
        const officeLocation = { lat: -37.815670, lng: 144.961310 };  // Example: Melbourne

        // Function to calculate distance using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radius of the Earth in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in meters
        }

        // Function to get user's current location from IP
        async function getUserLocation() {
            const response = await fetch('https://ipinfo.io/json?token=43e1137f8c2858'); // Replace with your API token
            const data = await response.json();
            const [lat, lon] = data.loc.split(',');
            return { lat: parseFloat(lat), lon: parseFloat(lon), address: data.city + ', ' + data.region };
        }

        // Main function
        async function checkLocation() {
            const userLocation = await getUserLocation();
            const distance = calculateDistance(
                officeLocation.lat, officeLocation.lon, 
                userLocation.lat, userLocation.lon
            );

            if (distance > 500) {
                document.getElementById('message').textContent = 'You are far away from the office location!';
                document.getElementById('address').textContent = userLocation.address;
                document.getElementById('distance').textContent = Math.round(distance);
                document.getElementById('popup').style.display = 'block';
            } else {
                window.location.href = 'https://apps.powerapps.com/play/e/default-c09afb75-1cf8-46ca-9c5e-0a01bfbd86f2/a/da6abc26-4882-4681-89e0-709dba447700?tenantId=c09afb75-1cf8-46ca-9c5e-0a01bfbd86f2&hint=857d0959-b069-46c2-96f9-3fbf3f1d5fc6&sourcetime=1729052168205&source=portal';
            }
        }

        // Run the check on page load
        checkLocation();
    </script>
</body>
</html>
